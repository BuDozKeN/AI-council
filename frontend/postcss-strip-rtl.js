/**
 * PostCSS plugin to strip RTL language selectors generated by Tailwind v4
 *
 * This plugin removes the verbose :lang(...) pseudo-classes that Tailwind v4
 * adds for RTL language support, reducing bundle size by ~400KB.
 *
 * We don't need RTL support for 19 different languages, so we strip them out.
 */

const LANG_REGEX = /:(not\()?:?(-webkit-any\(|is\()?:lang\([^)]+\)\)?/g;

const stripRTL = () => {
  return {
    postcssPlugin: 'postcss-strip-rtl',
    Rule(rule) {
      // Check if rule selector contains :lang() pseudo-classes
      if (rule.selector && rule.selector.includes(':lang(')) {
        // Remove the entire rule if it ONLY contains RTL language selectors
        const hasOnlyLangSelectors = rule.selector.match(LANG_REGEX);

        if (hasOnlyLangSelectors) {
          // Check if this is a RTL-specific rule (not a LTR rule)
          // LTR rules have :not(:lang(...)), RTL rules have :lang(...) or :-webkit-any(:lang(...))
          const isRTLRule =
            rule.selector.includes(':-webkit-any(:lang(') ||
            (rule.selector.includes(':is(:lang(') && !rule.selector.includes(':not('));

          if (isRTLRule) {
            // Remove RTL-specific rules entirely
            rule.remove();
            return;
          }

          // For LTR rules (:not(:lang(...))), simplify to remove the lang check
          // Example: .foo:not(:lang(ar)) { right: 8px; } â†’ .foo { right: 8px; }
          rule.selector = rule.selector.replace(LANG_REGEX, '');

          // Clean up any leftover pseudo-class artifacts
          rule.selector = rule.selector
            .replace(/:not\(\)/g, '') // Remove empty :not()
            .replace(/:{2,}/g, ':') // Remove multiple colons
            .replace(/\s+/g, ' ') // Normalize whitespace
            .trim();

          // If selector became empty or invalid, remove the rule
          if (!rule.selector || rule.selector === '') {
            rule.remove();
          }
        }
      }
    },
  };
};

stripRTL.postcss = true;

export default stripRTL;
